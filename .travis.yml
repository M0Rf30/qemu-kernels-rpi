language: bash
cache: ccache
services:
    - docker
before_install:
    - 'cd /home/travis'
    - 'git clone https://github.com/M0Rf30/qemu-kernels-rpi-arch-arm'
    - 'sudo chown -R root:root qemu-kernels-rpi-arch-arm'
    - 'docker pull m0rf30/arch-arm-crosscompile'
script:
    - 'sudo docker run -u root -v /home/travis/.ccache:/root/.ccache -v /home/travis/qemu-kernels-rpi-arch-arm:/mnt m0rf30/arch-arm-crosscompile:latest bash -c "cd /mnt; ./build_all.sh"'
before_deploy:
    - 'cd /home/travis/qemu-kernels-rpi-arch-arm' 
    - 'sudo git config --local user.name "M0Rf30"'
    - 'sudo git config --local user.email "morf3089@gmail.com"'
    - 'export TRAVIS_TAG=${TRAVIS_TAG:-$(date +''%Y%m%d%H%M%S'')-$(git log --format=%h -1)}'
    - 'sudo git tag $TRAVIS_TAG'
deploy:
    provider: release
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    file_glob: true
    file:
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi/build/qemu-*'
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi2/build/qemu-*'
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi3/build/qemu-*'
    on:
        branch: master
