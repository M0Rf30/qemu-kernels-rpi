language: bash
cache: ccache
services:
    - docker
before_install:
    - 'cd /home/travis'
    - 'git clone https://github.com/M0Rf30/qemu-kernels-rpi-arch-arm'
    - 'sudo chown -R root:root qemu-kernels-rpi-arch-arm'
    - 'docker pull m0rf30/arch-arm-crosscompile'
script:
    - 'sudo docker run -u root -v /home/travis/.ccache:/root/.ccache -v /home/travis/qemu-kernels-rpi-arch-arm:/mnt m0rf30/arch-arm-crosscompile:latest bash -c "cd /mnt; ./build_all.sh"'
before_deploy:
    - 'cd /home/travis/qemu-kernels-rpi-arch-arm' 
    - 'sudo git config --local user.name "M0Rf30"'
    - 'sudo git config --local user.email "morf3089@gmail.com"'
    - export GIT_TAG=$TRAVIS_BRANCH-0.1.$TRAVIS_BUILD_NUMBER
    - git tag $GIT_TAG -a -m "Generated tag from TravisCI for build $TRAVIS_BUILD_NUMBER"
    - git push -q https://$TAGPERM@github.com/M0Rf30/qemu-kernels-rpi-arch-arm --tags
    - ls -R
deploy:
    provider: releases
    skip_cleanup: true
    api_key:
        secure: $GH_TOKEN
    file_glob: true
    file:
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi/build/qemu-*'
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi2/build/qemu-*'
        - '/home/travis/qemu-kernels-rpi-arch-arm/rpi3/build/qemu-*'
    on:
        repo: https://github.com/M0Rf30/qemu-kernels-rpi-arch-arm
        branch: master
        all_branches: true
branches:
    except:
        - /^*-v[0-9]/
